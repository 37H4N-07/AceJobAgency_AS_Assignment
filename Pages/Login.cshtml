@page
@model AceJobAgency_AS_Assignment.Pages.LoginModel
@{
    ViewData["Title"] = "Login";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card shadow-lg">
                <div class="card-header text-white text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3>Welcome Back</h3>
                </div>
                <div class="card-body p-4">
                    <form method="post">
                        <div asp-validation-summary="All" class="text-danger mb-3"></div>

                        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                        {
                            <div class="alert alert-danger">@Model.ErrorMessage</div>
                        }

                        <div class="mb-3">
                            <label asp-for="Input.Email" class="form-label">Email Address</label>
                            <input asp-for="Input.Email" class="form-control" type="email" autofocus />
                            <span asp-validation-for="Input.Email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.Password" class="form-label">Password</label>
                            <input asp-for="Input.Password" class="form-control" type="password" />
                            <span asp-validation-for="Input.Password" class="text-danger"></span>
                        </div>

                        <input type="hidden" id="recaptchaToken" name="RecaptchaToken" />

                        <button type="submit" class="btn btn-primary w-100 btn-lg">Login</button>

                        <div class="mt-3 text-center">
                            <a asp-page="/ForgotPassword" class="text-muted">Forgot Password?</a>
                        </div>

                        <hr />

                        <div class="text-center">
                            <p>Don't have an account? <a asp-page="/Register">Register here</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://www.google.com/recaptcha/api.js?render=@Model.RecaptchaSiteKey"></script>
    <script>
        grecaptcha.ready(function() {
            console.log('reCAPTCHA loaded successfully');

            const form = document.querySelector('form');

            form.addEventListener('submit', function(event) {
                event.preventDefault();

                console.log('Form submitted, generating reCAPTCHA token...');

                grecaptcha.execute('@Model.RecaptchaSiteKey', {action: 'login'}).then(function(token) {
                    console.log('reCAPTCHA token generated:', token.substring(0, 50) + '...');
                    document.getElementById('recaptchaToken').value = token;
                    form.submit();
                }).catch(function(error) {
                    console.error('reCAPTCHA error:', error);
                    alert('reCAPTCHA verification failed. Please refresh the page and try again.');
                });
            });
        });
    </script>
}